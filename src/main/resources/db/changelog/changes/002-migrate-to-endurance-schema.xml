<?xml version="1.1" encoding="UTF-8" standalone="no"?>
<databaseChangeLog
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-latest.xsd">

    <changeSet id="002" author="thonbecker">
        <!-- This migration helps migrate existing data from public schema to endurance schema -->
        <!-- It's safe to run even if no data exists -->
        
        <!-- Check if tables exist in public schema and migrate them -->
        <sql>
            -- Create endurance schema if it doesn't exist
            CREATE SCHEMA IF NOT EXISTS endurance;
            
            -- Set search path to endurance
            SET search_path TO endurance, public;
        </sql>
        
        <!-- Migrate quiz table if it exists in public -->
        <sql>
            INSERT INTO endurance.quiz (id, title, time_per_question_in_seconds, status, created_at)
            SELECT id, title, time_per_question_in_seconds, status, created_at
            FROM endurance.quiz
            WHERE NOT EXISTS (SELECT 1 FROM endurance.quiz WHERE endurance.quiz.id = endurance.quiz.id);
        </sql>
        
        <!-- Migrate question table if it exists in public -->
        <sql>
            INSERT INTO endurance.question (id, quiz_id, question_text, correct_option_index, points, question_order)
            SELECT id, quiz_id, question_text, correct_option_index, points, question_order
            FROM endurance.question
            WHERE NOT EXISTS (SELECT 1 FROM endurance.question WHERE endurance.question.id = endurance.question.id);
        </sql>
        
        <!-- Migrate question_option table if it exists in public -->
        <sql>
            INSERT INTO endurance.question_option (id, question_id, option_text, option_order)
            SELECT id, question_id, option_text, option_order
            FROM endurance.question_option
            WHERE NOT EXISTS (SELECT 1 FROM endurance.question_option WHERE endurance.question_option.id = endurance.question_option.id);
        </sql>
        
        <!-- Migrate player table if it exists in public -->
        <sql>
            INSERT INTO endurance.player (id, name, created_at)
            SELECT id, name, created_at
            FROM endurance.player
            WHERE NOT EXISTS (SELECT 1 FROM endurance.player WHERE endurance.player.id = endurance.player.id);
        </sql>
        
        <!-- Migrate quiz_player table if it exists in public -->
        <sql>
            INSERT INTO endurance.quiz_player (quiz_id, player_id, score, is_ready)
            SELECT quiz_id, player_id, score, is_ready
            FROM endurance.quiz_player
            WHERE NOT EXISTS (SELECT 1 FROM endurance.quiz_player WHERE endurance.quiz_player.quiz_id = endurance.quiz_player.quiz_id AND endurance.quiz_player.player_id = endurance.quiz_player.player_id);
        </sql>
        
        <!-- Migrate answer_submission table if it exists in public -->
        <sql>
            INSERT INTO endurance.answer_submission (id, player_id, quiz_id, question_id, selected_option, submission_time, created_at)
            SELECT id, player_id, quiz_id, question_id, selected_option, submission_time, created_at
            FROM endurance.answer_submission
            WHERE NOT EXISTS (SELECT 1 FROM endurance.answer_submission WHERE endurance.answer_submission.id = endurance.answer_submission.id);
        </sql>
    </changeSet>
</databaseChangeLog>
