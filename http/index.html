<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Endurance WebSocket Tester</title>
    <style>
        body { font-family: sans-serif; margin: 20px; }
        .container { display: flex; gap: 20px; margin-bottom: 20px; }
        .panel { border: 1px solid #ccc; padding: 15px; border-radius: 8px; min-width: 300px; }
        .panel h2 { margin-top: 0; color: #333; }
        .log { border: 1px solid #eee; padding: 10px; height: 300px; overflow-y: scroll; background: #f9f9f9; font-family: monospace; font-size: 12px; }
        input, button, select { margin: 5px 0; padding: 5px; }
        button { background: #007cba; color: white; border: none; padding: 8px 15px; cursor: pointer; border-radius: 4px; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        button:hover:not(:disabled) { background: #005a87; }
        input[type="text"], input[type="number"], select { border: 1px solid #ddd; padding: 8px; border-radius: 4px; width: 200px; }
        .status { font-weight: bold; margin: 10px 0; }
        .connected { color: green; }
        .disconnected { color: red; }
        .quiz-display { background: #f0f8ff; padding: 15px; margin: 10px 0; border-radius: 8px; border: 1px solid #b0d4f1; }
        .question-options { margin: 10px 0; }
        .question-options button { margin: 5px; background: #28a745; }
        .question-options button:hover { background: #218838; }
        .player-info { background: #fff3cd; padding: 10px; margin: 5px 0; border-radius: 4px; border: 1px solid #ffeaa7; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
</head>
<body>
    <h1>Endurance Quiz WebSocket Tester</h1>
    
    <div class="container">
        <div class="panel">
            <h2>Connection</h2>
            <button id="connect" onclick="connect()">Connect</button>
            <button id="disconnect" onclick="disconnect()" disabled>Disconnect</button>
            <div id="status" class="status disconnected">Disconnected</div>
        </div>
        <div class="panel">
            <h2>Current Quiz Info</h2>
            <div id="current-quiz-info">
                <div>Quiz ID: <span id="current-quiz-id">None</span></div>
                <div>Player ID: <span id="current-player-id">None</span></div>
                <div>Player Name: <span id="current-player-name">None</span></div>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="panel">
            <h2>Create Quiz</h2>
            <input type="text" id="create-title" placeholder="Quiz Title" value="Test Quiz">
            <button onclick="createQuiz()">Create Empty Quiz</button>
        </div>
        <div class="panel">
            <h2>Create Trivia Quiz</h2>
            <input type="text" id="trivia-title" placeholder="Quiz Title" value="Dave Ramsey Trivia">
            <input type="number" id="trivia-count" placeholder="Question Count" value="3" min="1" max="10">
            <select id="trivia-difficulty">
                <option value="EASY">Easy</option>
                <option value="MEDIUM">Medium</option>
                <option value="HARD">Hard</option>
            </select>
            <button onclick="createTriviaQuiz()">Create Trivia Quiz</button>
        </div>
    </div>

    <div class="container">
        <div class="panel">
            <h2>Join Quiz</h2>
            <input type="number" id="quiz-id" placeholder="Quiz ID">
            <input type="text" id="player-name" placeholder="Player Name" value="TestPlayer">
            <button onclick="joinQuiz()">Join Quiz</button>
        </div>
        <div class="panel">
            <h2>Quiz Control</h2>
            <button onclick="startQuiz()">Start Quiz</button>
            <button onclick="pauseQuiz()">Pause Quiz</button>
            <button onclick="endQuiz()">End Quiz</button>
        </div>
    </div>

    <div class="container">
        <div class="panel" style="flex: 2;">
            <h2>Current Question</h2>
            <div id="current-question" class="quiz-display">
                <div>No active question</div>
            </div>
        </div>
        <div class="panel">
            <h2>Manual Answer Submit</h2>
            <input type="number" id="submit-quiz-id" placeholder="Quiz ID">
            <input type="text" id="submit-player-id" placeholder="Player ID">
            <input type="number" id="submit-question-id" placeholder="Question ID">
            <input type="number" id="submit-option-id" placeholder="Option ID (0-3)">
            <button onclick="submitAnswer()">Submit Answer</button>
        </div>
    </div>

    <div class="container">
        <div class="panel" style="flex: 1;">
            <h2>Activity Log</h2>
            <button onclick="clearLog()">Clear Log</button>
            <div id="logs" class="log"></div>
        </div>
    </div>

    <script>
        let stompClient = null;
        let currentQuiz = null;
        let currentPlayer = null;
        let currentQuestion = null;
        const logs = document.getElementById('logs');
        const status = document.getElementById('status');

        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            const p = document.createElement('div');
            p.innerHTML = `<strong>${timestamp}:</strong> ${message}`;
            logs.appendChild(p);
            logs.scrollTop = logs.scrollHeight;
        }

        function clearLog() {
            logs.innerHTML = '';
        }

        function updateCurrentQuizInfo() {
            document.getElementById('current-quiz-id').textContent = currentQuiz ? currentQuiz.id : 'None';
            document.getElementById('current-player-id').textContent = currentPlayer ? currentPlayer.id : 'None';
            document.getElementById('current-player-name').textContent = currentPlayer ? currentPlayer.name : 'None';
        }

        function displayQuestion(questionData) {
            const questionDiv = document.getElementById('current-question');
            if (!questionData) {
                questionDiv.innerHTML = '<div>No active question</div>';
                return;
            }

            let html = `
                <div><strong>Question:</strong> ${questionData.questionText}</div>
                <div><strong>Points:</strong> ${questionData.points}</div>
                <div class="question-options">
            `;
            
            questionData.options.forEach((option, index) => {
                html += `<button onclick="answerQuestion(${index})">${String.fromCharCode(65 + index)}: ${option}</button>`;
            });
            
            html += '</div>';
            questionDiv.innerHTML = html;
            
            // Auto-fill the manual submit form
            if (currentQuiz && currentPlayer) {
                document.getElementById('submit-quiz-id').value = currentQuiz.id;
                document.getElementById('submit-player-id').value = currentPlayer.id;
                document.getElementById('submit-question-id').value = questionData.id;
            }
        }

        function answerQuestion(optionIndex) {
            if (!currentQuiz || !currentPlayer || !currentQuestion) {
                log('ERROR: Missing quiz, player, or question data');
                return;
            }
            
            const submission = {
                quizId: currentQuiz.id,
                playerId: currentPlayer.id,
                questionId: currentQuestion.id,
                optionId: optionIndex
            };
            
            log(`Submitting answer: Option ${String.fromCharCode(65 + optionIndex)} (${optionIndex})`);
            stompClient.send("/app/quiz/submit", {}, JSON.stringify(submission));
        }

        function connect() {
            const socket = new SockJS('http://localhost:8080/quiz-websocket');
            stompClient = Stomp.over(socket);
            
            stompClient.connect({}, function (frame) {
                status.textContent = 'Connected';
                status.className = 'status connected';
                document.getElementById('connect').disabled = true;
                document.getElementById('disconnect').disabled = false;
                log('‚úÖ Connected to WebSocket');

                // Subscribe to quiz creation
                stompClient.subscribe('/topic/quiz/created', function (message) {
                    const quiz = JSON.parse(message.body);
                    currentQuiz = quiz;
                    updateCurrentQuizInfo();
                    document.getElementById('quiz-id').value = quiz.id;
                    log(`üéØ Quiz Created: "${quiz.title}" (ID: ${quiz.id})`);
                });

                // Subscribe to player updates
                stompClient.subscribe('/topic/quiz/players', function (message) {
                    const players = JSON.parse(message.body);
                    log(`üë• Players updated: ${players.length} players`);
                    players.forEach(player => {
                        log(`   - ${player.name} (ID: ${player.id})`);
                    });
                });

            }, function(error) {
                log('‚ùå Connection failed: ' + error);
                status.textContent = 'Connection Failed';
                status.className = 'status disconnected';
            });
        }

        function disconnect() {
            if (stompClient !== null) {
                stompClient.disconnect();
            }
            status.textContent = 'Disconnected';
            status.className = 'status disconnected';
            document.getElementById('connect').disabled = false;
            document.getElementById('disconnect').disabled = true;
            log('üîå Disconnected');
        }

        function createQuiz() {
            if (!stompClient) {
                log('‚ùå Not connected');
                return;
            }
            const title = document.getElementById('create-title').value;
            stompClient.send("/app/quiz/create", {}, JSON.stringify({'title': title, 'questions': []}));
            log(`üìù Creating quiz: "${title}"`);
        }

        function createTriviaQuiz() {
            if (!stompClient) {
                log('‚ùå Not connected');
                return;
            }
            const title = document.getElementById('trivia-title').value;
            const questionCount = parseInt(document.getElementById('trivia-count').value);
            const difficulty = document.getElementById('trivia-difficulty').value;
            
            const request = {
                title: title, 
                questionCount: questionCount, 
                difficulty: difficulty
            };
            
            stompClient.send("/app/quiz/create/trivia", {}, JSON.stringify(request));
            log(`üß† Creating trivia quiz: "${title}" (${questionCount} questions, ${difficulty})`);
        }

        function joinQuiz() {
            if (!stompClient) {
                log('‚ùå Not connected');
                return;
            }
            const quizId = parseInt(document.getElementById('quiz-id').value);
            const playerName = document.getElementById('player-name').value;
            
            currentPlayer = { name: playerName, id: playerName }; // Simplified ID
            
            const request = {
                quizId: quizId, 
                player: { 
                    id: currentPlayer.id,
                    name: playerName,
                    isReady: true
                }
            };
            
            stompClient.send("/app/quiz/join", {}, JSON.stringify(request));
            updateCurrentQuizInfo();
            log(`üö™ Joining quiz ${quizId} as "${playerName}"`);
        }

        function startQuiz() {
            if (!stompClient) {
                log('‚ùå Not connected');
                return;
            }
            const quizId = parseInt(document.getElementById('quiz-id').value);
            
            // Subscribe to quiz state updates for this quiz
            stompClient.subscribe('/topic/quiz/state/' + quizId, function (message) {
                const state = JSON.parse(message.body);
                currentQuestion = state.currentQuestion;
                log(`üéÆ Quiz State Update: Question ${state.currentQuestionIndex + 1}`);
                displayQuestion(state.currentQuestion);
                
                // Log scores
                if (state.playerScores) {
                    Object.entries(state.playerScores).forEach(([playerId, score]) => {
                        log(`   ${playerId}: ${score} points`);
                    });
                }
            });
            
            stompClient.send("/app/quiz/start", {}, quizId.toString());
            log(`‚ñ∂Ô∏è Starting quiz ${quizId}`);
        }
        
        function pauseQuiz() {
            if (!stompClient) {
                log('‚ùå Not connected');
                return;
            }
            const quizId = parseInt(document.getElementById('quiz-id').value);
            stompClient.send("/app/quiz/pause", {}, quizId.toString());
            log(`‚è∏Ô∏è Pausing quiz ${quizId}`);
        }

        function endQuiz() {
            if (!stompClient) {
                log('‚ùå Not connected');
                return;
            }
            const quizId = parseInt(document.getElementById('quiz-id').value);
            stompClient.send("/app/quiz/end", {}, quizId.toString());
            log(`üèÅ Ending quiz ${quizId}`);
        }

        function submitAnswer() {
            if (!stompClient) {
                log('‚ùå Not connected');
                return;
            }
            const quizId = parseInt(document.getElementById('submit-quiz-id').value);
            const playerId = document.getElementById('submit-player-id').value;
            const questionId = parseInt(document.getElementById('submit-question-id').value);
            const optionId = parseInt(document.getElementById('submit-option-id').value);
            
            const submission = {
                quizId: quizId,
                playerId: playerId,
                questionId: questionId,
                optionId: optionId
            };
            
            stompClient.send("/app/quiz/submit", {}, JSON.stringify(submission));
            log(`üì§ Manual answer submitted: Quiz ${quizId}, Player ${playerId}, Question ${questionId}, Option ${optionId}`);
        }

        // Auto-connect on page load for easier testing
        window.addEventListener('load', function() {
            setTimeout(connect, 500);
        });
    </script>
</body>
</html>
